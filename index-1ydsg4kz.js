var F=["#fff","#acffaa"];var w={COLOR:"#ddd",WIDTH:2},j=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]],z={OVERPOPULATION:3,UNDERPOPULATION:2,NEWBORN:3};class k{canvas;ctx;cols;rows;field;isSetting=!0;timeOut;frame;isRunning=!1;abortController=new AbortController;hasSignsOfLife=!1;constructor(d,t,m){this.canvas=document.getElementById(d),this.ctx=this.canvas.getContext("2d"),this.cols=t,this.rows=m,this.canvas.width=this.cols*15,this.canvas.height=this.rows*15,this.init()}generateField=()=>{return Array.from(new Array(this.rows),(d,t)=>new Proxy(new Array(this.cols).fill(0),{set:(...m)=>{let p=Number(m[1]),b=Reflect.set(...m);if(b)this.drawCell(p*15,t*15,F[this.field[t][p]]);return b}}))};drawCell=(d,t,m)=>{this.ctx.fillStyle=m,this.ctx.fillRect(d,t,15,15),this.ctx.lineWidth=w.WIDTH,this.ctx.strokeStyle=w.COLOR,this.ctx.strokeRect(d,t,15,15)};drawGrid=()=>{this.ctx.rect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle=F[0],this.ctx.fill(),this.ctx.beginPath();for(let d=0;d<this.canvas.width;d+=15)this.ctx.moveTo(d,0),this.ctx.lineTo(d,this.canvas.height);for(let d=0;d<this.canvas.height;d+=15)this.ctx.moveTo(0,d),this.ctx.lineTo(this.canvas.width,d);this.ctx.lineWidth=w.WIDTH,this.ctx.strokeStyle=w.COLOR,this.ctx.stroke()};getCellCoords=({offsetX:d,offsetY:t})=>{return{x:Math.floor(d/15),y:Math.floor(t/15)}};setMode=(d)=>{let{x:t,y:m}=this.getCellCoords(d);this.isSetting=!this.field[m]?.[t],this.setFirstGen(d)};setFirstGen=(d)=>{if(d.buttons!==1||d.offsetY<0||d.offsetY>=this.canvas.height)return;let{x:t,y:m}=this.getCellCoords(d);this.field[m][t]=+this.isSetting};getNeighboursCount=(d,t)=>{let m=0;for(let p=0;p<j.length;p++){if(m>z.OVERPOPULATION)break;let b=j[p],r=d+b[0],v=t+b[1];if(r<0)r=this.cols-1;else if(r>=this.cols)r=0;if(v<0)v=this.rows-1;else if(v>=this.rows)v=0;m+=this.field[v][r]}return m};getCellState=(d,t)=>{let m=this.getNeighboursCount(d,t),p=this.field[t][d];if(p&&(m>z.OVERPOPULATION||m<z.UNDERPOPULATION))p=0;else if(!p&&m===z.NEWBORN)p=1;return p};updateField=()=>{let d=[];this.hasSignsOfLife=!1;for(let t=0;t<this.cols;t++)for(let m=0;m<this.rows;m++){let p=this.getCellState(t,m);if(p!==this.field[m][t])d.push({x:t,y:m,state:p});if(p&&!this.hasSignsOfLife)this.hasSignsOfLife=Boolean(p)}if(!d.length){if(this.isRunning=!1,cancelAnimationFrame(this.frame),clearTimeout(this.timeOut),alert(`Our civilization has ${this.hasSignsOfLife?"reached harmony!":"perished :("}`),!this.hasSignsOfLife)this.reset()}for(let t=0;t<d.length;t++){let m=d[t];this.field[m.y][m.x]=m.state}};render=()=>{if(!this.isRunning)return;this.updateField(),this.timeOut=setTimeout(()=>{this.frame=requestAnimationFrame(this.render)},200)};init=()=>{if(this.isRunning=!1,this.abortController.signal.aborted)this.abortController=new AbortController;let d=this.abortController.signal;this.canvas.addEventListener("mousemove",this.setFirstGen,{signal:d}),this.canvas.addEventListener("mousedown",this.setMode,{signal:d}),this.field=this.generateField(),this.hasSignsOfLife=!0,this.drawGrid()};start=()=>{if(this.isRunning)return;this.isRunning=!0,this.abortController.abort(),this.render()};reset=()=>{clearTimeout(this.timeOut),cancelAnimationFrame(this.frame),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.init()}}var q=new k("canvas",100,50);document.getElementById("start").addEventListener("click",q.start);document.getElementById("reset").addEventListener("click",q.reset);
